package com.ggul.zip.controller;

import java.io.File;
import java.io.IOException;
import java.sql.Date;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import javax.servlet.http.Part;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;

import com.ggul.zip.lesson.LessonService;
import com.ggul.zip.lesson.LessonVO;
import com.ggul.zip.tiper.TiperService;
import com.ggul.zip.tiper.TiperVO;
import com.ggul.zip.user.UserService;
import com.ggul.zip.user.UserVO;

@Controller
public class TiperController {

	@Autowired
	private UserService userService;

	@Autowired
	private TiperService tiperService;

	@Autowired
	private LessonService lessonService;

	// 상현이부분

	// 강사 마이페이지 이동
	@RequestMapping(value = "/tiperMypage")
	public String tiperMypage(HttpServletRequest request, HttpSession session, UserVO vo, TiperVO tiperVO,
			LessonVO lessonVO) {
		tiperVO.setTiper_user_id((String) session.getAttribute("user_id"));
		vo.setUser_id((String) session.getAttribute("user_id"));
		vo.setUser_point(userService.pointSelect(vo));
		session.setAttribute("user_point", vo.getUser_point());
		tiperVO = tiperService.selectTiperInfo(tiperVO);
		lessonVO.setLesson_tiper_code(tiperVO.getTiper_code());
		request.setAttribute("lessonTiper", lessonService.selectLessonTiper(lessonVO));

		return "tiper/tiperMypage";

	}

	// 허니페이 정산창 이동
	@RequestMapping(value = "/honeyTake")
	public String honeyTake() {
		return "tiper/tiperHoneyTake";

	}

	// 강사 정보 수정 페이지 이동
	@RequestMapping(value = "/tiperUpdateGo")
	public String tiperUpdateGo(HttpServletRequest request, HttpSession session, LessonVO lessonVO, TiperVO tiperVO,
			UserVO vo) {
		String userId = (String) session.getAttribute("user_id");
		vo.setUser_id(userId);
		vo = userService.selectName(vo);
		System.out.println(vo.getUser_name());
		request.setAttribute("user_name", vo.getUser_name());
		tiperVO.setTiper_user_id(userId);
		tiperVO = tiperService.selectTiperInfo(tiperVO);
		lessonVO.setLesson_tiper_code(tiperVO.getTiper_code());
		request.setAttribute("lessonTiper", lessonService.selectLessonName(lessonVO));
		return "tiper/tiperInfoUpdate";

	}

	// 강의 정보 수정 페이지 이동
	@RequestMapping(value = "/lessonUpdateGo")
	public String lessonUpdateGo(HttpServletRequest request, HttpSession session, LessonVO lessonVO) {
		lessonVO.setLesson_num(Integer.parseInt(request.getParameter("lesson_num")));
		lessonVO = lessonService.selectLessonNum(lessonVO);
		request.setAttribute("lesson", lessonVO);
		return "tiper/tiperLessonUpdate";

	}

	// 강의 등록 페이지 이동
	@RequestMapping(value = "/lessonMakeGo")
	public String lessonMakeGO(HttpServletRequest request, HttpSession session, TiperVO tiperVO) {
		tiperVO.setTiper_user_id((String) session.getAttribute("user_id"));
		tiperVO = tiperService.selectTiperInfo(tiperVO);
		System.out.println(tiperVO.getTiper_cate1());
		request.setAttribute("tiperGo", tiperVO);
		return "tiper/tiperLessonMake";
	}

	// 유저 마이페이지 이동

	@RequestMapping(value = "/userMyPageGo")
	public String myPageGo(HttpServletRequest request, HttpSession session, UserVO vo, LessonVO lessonVO,
			TiperVO tiperVO) {
		vo.setUser_id((String) session.getAttribute("user_id"));
		tiperVO.setTiper_user_id((String) session.getAttribute("user_id"));
		tiperVO = tiperService.selectTiperInfo(tiperVO);
		vo.setUser_point(userService.pointSelect(vo));
		session.setAttribute("user_point", vo.getUser_point());
		request.setAttribute("myTiper", tiperVO);
		lessonVO.setLesson_info((String) session.getAttribute("user_id"));
		request.setAttribute("lessonList", lessonService.getUserLessonList(lessonVO));
		return "user/userMyPage";

	}

	// 회원 탈퇴
	@RequestMapping(value = "/userDeleteAction")
	public String userDeleteAction(HttpServletRequest req, HttpServletResponse res, HttpSession session, UserVO vo) {
		String userId = (String) session.getAttribute("user_id");
		vo.setUser_id(userId);
		userService.delUser(vo);
		session.invalidate();
		return "index";
	}

	// 회원 정보 수정하기
	@RequestMapping(value = "/userUpdateAction")
	public String userUpdateAction(HttpServletRequest req, HttpServletResponse res, HttpSession session, UserVO vo) {
		String userId = (String) session.getAttribute("user_id");
		vo.setUser_id(userId);
		userService.updateUser(vo);
		return "redirect:userMyPageGo";
	}

	// 회원정보수정 페이지 이동
	@RequestMapping(value = "/userUpdateGo")
	public String userUpdateGo(HttpSession session, UserVO vo, Model model) {
		vo.setUser_id((String) session.getAttribute("user_id"));
		vo = userService.selectName(vo);
		System.out.println(vo.getUser_cate());
		model.addAttribute("userVO", vo);
		return "user/userInfoUpdate";
	}

	// 강사신청 액션
	@ResponseBody
	@RequestMapping(value = "/tiperSignUp")
	public String tiperSignUp(HttpServletRequest req, HttpServletResponse res, HttpSession session, UserVO vo,
			TiperVO tiperVO) {
		String msg = "";
		String userId = (String) session.getAttribute("user_id");
		tiperVO.setTiper_user_id(userId);
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
		Calendar c1 = Calendar.getInstance();
		Date d = (Date) c1.getTime();
		String strToday = sdf.format(d);
		tiperVO.setTiper_date(strToday);
		System.out.println(tiperVO.getTiper_img());
		tiperService.insertTiper(tiperVO);
		msg = "<script>location.href='userMyPageGo';</script>";
		return msg;
	}

	@RequestMapping(value = "/upload", method = RequestMethod.POST)
	public ResponseEntity<String> uploadFile(HttpServletRequest request) {

		// 업로드한 파일 정보 가져오기
		Part part = request.getPart("tiper_img");
		String fileName = getFileName(part);
		String filePath = "C:\\Springwork\\honeytiper999\\src\\main\\webapp\\resources\\img\\" + fileName;

		// 파일 저장
		try {
			part.write(filePath);
			return ResponseEntity.ok().body("File uploaded successfully");
		} catch (IOException e) {
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Failed to upload file");
		}
	}

	private String getFileName(Part part) {
		String contentDisposition = part.getHeader("content-disposition");
		String[] tokens = contentDisposition.split(";");
		for (String token : tokens) {
			if (token.trim().startsWith("filename")) {
				return token.substring(token.indexOf("=") + 2, token.length() - 1);
			}
		}
		return "";
	}

}
